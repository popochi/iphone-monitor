<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone最安値チェッカー | 価格比較</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header -->
        <!-- Header Removed -->

        <!-- Controls -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">

            <!-- Top Row: Price Mode Toggle -->
            <div class="flex justify-center mb-6">
                <div class="bg-gray-100 p-1 rounded-lg inline-flex">
                    <button id="mode-rent"
                        class="px-4 py-2 rounded-md text-sm font-bold transition-all shadow-sm bg-white text-blue-600">
                        実質負担 (2年返却)
                    </button>
                    <button id="mode-buyout"
                        class="px-4 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700">
                        一括購入
                    </button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">

                <!-- Left: Filters -->
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Carriers -->
                    <div class="flex items-center gap-2">
                        <label class="font-bold text-gray-700">表示:</label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="filter-carrier form-checkbox h-5 w-5 text-blue-600"
                                value="Rakuten" checked>
                            <span class="ml-2 text-gray-700">楽天モバイル</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="filter-carrier form-checkbox h-5 w-5 text-green-600"
                                value="ahamo" checked>
                            <span class="ml-2 text-gray-700">ahamo</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="filter-carrier form-checkbox h-5 w-5 text-pink-600"
                                value="UQ mobile" checked>
                            <span class="ml-2 text-gray-700">UQ mobile</span>
                        </label>
                    </div>

                    <!-- Vertical Divider (Desktop) -->
                    <div class="hidden md:block w-px h-8 bg-gray-300 mx-2"></div>

                    <!-- Dropdowns -->
                    <div class="flex flex-wrap gap-2">
                        <select id="filter-model"
                            class="border border-gray-300 rounded px-3 py-2 text-base md:text-sm focus:outline-none focus:border-blue-500 w-full md:w-auto">
                            <option value="All">全モデル</option>
                        </select>
                        <select id="filter-storage"
                            class="border border-gray-300 rounded px-3 py-2 text-base md:text-sm focus:outline-none focus:border-blue-500 w-full md:w-auto">
                            <option value="All">全容量</option>
                        </select>
                    </div>
                </div>

                <!-- Right: Sort -->
                <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                    <label for="sort-select" class="font-bold text-gray-700 whitespace-nowrap">並び替え:</label>
                    <select id="sort-select"
                        class="border border-gray-300 rounded px-3 py-2 text-base md:text-sm focus:outline-none focus:border-blue-500 w-full md:w-auto">
                        <option value="price_asc">実質負担が安い順</option>
                        <option value="model_asc">モデル名順</option>
                    </select>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message"
                class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
                role="alert">
                <strong class="font-bold">エラー！</strong>
                <span class="block sm:inline" id="error-text">データの読み込みに失敗しました。</span>
            </div>

            <!-- Loading -->
            <div id="loading" class="text-center py-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-500">価格データを読み込み中...</p>
            </div>

            <!-- Table (Desktop) / Cards (Mobile) -->
            <div id="product-container" class="hidden">
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 hidden md:table-header-group">
                            <tr>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider w-20">画像</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">モデル</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">容量</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">キャリア</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">定価
                                </th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">
                                    キャンペーン適用後実質負担</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center">購入
                                </th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="divide-y divide-gray-200 block md:table-row-group">
                            <!-- Items injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- No Results -->
            <div id="no-results" class="hidden text-center py-10 text-gray-500">
                条件に一致する商品が見つかりませんでした。
            </div>

            <!-- Last Updated (Footer) -->
            <div class="mt-8 text-center text-gray-400 text-xs">
                最終更新: <span id="updated-at" class="font-medium">読み込み中...</span>
            </div>

        </div>

        <script>
            // State
            let allData = [];
            let carriers = ['Rakuten', 'ahamo', 'UQ mobile'];
            let selectedModel = 'All';
            let selectedStorage = 'All';
            let sortBy = 'price_asc';
            let priceMode = 'rent'; // 'rent' or 'buyout'

            // DOM Elements
            const updatedAtEl = document.getElementById('updated-at');
            const errorMessageEl = document.getElementById('error-message');
            const errorTextEl = document.getElementById('error-text');
            const loadingEl = document.getElementById('loading');
            const productContainerEl = document.getElementById('product-container');
            const productListEl = document.getElementById('product-list');
            const noResultsEl = document.getElementById('no-results');
            const sortSelect = document.getElementById('sort-select');
            const carrierCheckboxes = document.querySelectorAll('.filter-carrier');
            const filterModel = document.getElementById('filter-model');
            const filterStorage = document.getElementById('filter-storage');
            const modeRentBtn = document.getElementById('mode-rent');
            const modeBuyoutBtn = document.getElementById('mode-buyout');

            // Table Headers (Dynamic)
            // Indices shifted due to added Image column.
            const thPriceSub = document.querySelector('thead tr th:nth-child(5)');
            const thPriceMain = document.querySelector('thead tr th:nth-child(6)');

            // Init
            document.addEventListener('DOMContentLoaded', () => {
                fetchData();
                setupEventListeners();
            });

            function setupEventListeners() {
                // Price Mode Toggles
                modeRentBtn.addEventListener('click', () => setPriceMode('rent'));
                modeBuyoutBtn.addEventListener('click', () => setPriceMode('buyout'));

                sortSelect.addEventListener('change', (e) => {
                    sortBy = e.target.value;
                    render();
                });

                carrierCheckboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        carriers = Array.from(carrierCheckboxes)
                            .filter(c => c.checked)
                            .map(c => c.value);
                        render();
                    });
                });

                filterModel.addEventListener('change', (e) => {
                    selectedModel = e.target.value;
                    render();
                });

                filterStorage.addEventListener('change', (e) => {
                    selectedStorage = e.target.value;
                    render();
                });
            }

            async function fetchData() {
                try {
                    const response = await fetch('./data.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    updatedAtEl.textContent = data.updated_at || '不明';
                    allData = data.items;

                    populateFilters(allData);

                    // Initial sort/mark
                    markLowestPrices(allData);

                    loadingEl.classList.add('hidden');
                    productContainerEl.classList.remove('hidden');
                    render();

                } catch (err) {
                    console.error(err);
                    loadingEl.classList.add('hidden');
                    errorMessageEl.classList.remove('hidden');
                    errorTextEl.textContent = err.message + " メインスクリプトを実行してください。";
                }
            }

            function populateFilters(items) {
                // Models
                const models = [...new Set(items.map(i => i.model))].sort();
                filterModel.innerHTML = '<option value="All">全モデル</option>';
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    filterModel.appendChild(opt);
                });

                // Storage
                // Sort logic for storage: 64GB < 128GB < 256GB < 512GB < 1TB
                const storages = [...new Set(items.map(i => i.storage))];
                storages.sort((a, b) => {
                    const parseStorage = (s) => {
                        if (s.includes('TB')) return parseInt(s) * 1024;
                        return parseInt(s) || 9999;
                    };
                    return parseStorage(a) - parseStorage(b);
                });

                filterStorage.innerHTML = '<option value="All">全容量</option>';
                storages.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    filterStorage.appendChild(opt);
                });
            }

            function markLowestPrices(items) {
                // Group by Model + Storage
                const groups = {};
                items.forEach(item => {
                    const key = `${item.model}-${item.storage}`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(item);
                });

                // Find min price in each group based on current mode
                Object.values(groups).forEach(group => {
                    if (group.length === 0) return;

                    const minPrice = Math.min(...group.map(i => {
                        return priceMode === 'rent' ? i.price_effective_rent : i.price_effective_buyout;
                    }));

                    group.forEach(item => {
                        const price = priceMode === 'rent' ? item.price_effective_rent : item.price_effective_buyout;
                        item.isLowest = (price === minPrice);
                    });
                });
            }

            function setPriceMode(mode) {
                priceMode = mode;

                // Update UI styles
                if (mode === 'rent') {
                    modeRentBtn.className = "px-4 py-2 rounded-md text-sm font-bold transition-all shadow-sm bg-white text-blue-600 border border-blue-200";
                    modeBuyoutBtn.className = "px-4 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700 hover:bg-gray-200";

                    // Update Table Header
                    if (thPriceSub) thPriceSub.textContent = "定価";
                    if (thPriceMain) thPriceMain.textContent = "キャンペーン適用後実質負担";

                } else {
                    modeRentBtn.className = "px-4 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700 hover:bg-gray-200";
                    modeBuyoutBtn.className = "px-4 py-2 rounded-md text-sm font-bold transition-all shadow-sm bg-white text-blue-600 border border-blue-200";

                    // Update Table Header
                    if (thPriceSub) thPriceSub.textContent = "実質負担";
                    if (thPriceMain) thPriceMain.textContent = "一括購入実質";
                }

                markLowestPrices(allData);
                render();
            }

            function render() {
                // Filter
                let filtered = allData.filter(item => {
                    // Carrier
                    if (!carriers.includes(item.carrier)) return false;
                    // Model
                    if (selectedModel !== 'All' && item.model !== selectedModel) return false;
                    // Storage
                    if (selectedStorage !== 'All' && item.storage !== selectedStorage) return false;
                    return true;
                });

                // Sort
                filtered.sort((a, b) => {
                    // Determine price to sort by based on mode
                    const getPrice = (item) => priceMode === 'rent' ? (item.price_effective_rent || 0) : (item.price_effective_buyout || 0);

                    const priceA = getPrice(a);
                    const priceB = getPrice(b);

                    if (sortBy === 'price_asc') {
                        return priceA - priceB;
                    } else if (sortBy === 'model_asc') {
                        if (a.model < b.model) return -1;
                        if (a.model > b.model) return 1;
                        const storageA = parseInt(a.storage) || 0;
                        const storageB = parseInt(b.storage) || 0;
                        return storageA - storageB;
                    }
                    return 0;
                });

                // Render
                productListEl.innerHTML = '';

                if (filtered.length === 0) {
                    productContainerEl.classList.add('hidden');
                    noResultsEl.classList.remove('hidden');
                } else {
                    productContainerEl.classList.remove('hidden');
                    noResultsEl.classList.add('hidden');
                }

                filtered.forEach(item => {
                    const tr = document.createElement('tr');
                    // Mobile: block (card container), Desktop: table-row
                    tr.className = `block md:table-row bg-white mobile-card border-b border-gray-200 md:border-b-0 ${item.isLowest ? 'ring-2 ring-yellow-400 ring-inset md:ring-0' : ''}`;


                    // --- Prepare Values based on Mode ---
                    let mainPriceVal = 0;
                    let mainLabel = '';
                    let subPriceVal = 0;
                    let subLabel = '';

                    if (priceMode === 'rent') {
                        mainPriceVal = item.price_effective_rent;
                        mainLabel = "実質負担";
                        subPriceVal = item.price_gross;
                        subLabel = "定価";
                    } else {
                        // Buyout Mode
                        mainPriceVal = item.price_effective_buyout;
                        mainLabel = "一括実質";
                        subPriceVal = item.price_effective_rent;
                        subLabel = "実質負担";
                    }

                    const formatPrice = (p) => (p || 0).toLocaleString();
                    const mainPriceStr = formatPrice(mainPriceVal);
                    const subPriceStr = formatPrice(subPriceVal);

                    const rentExemptionBadge = (item.program_exemption > 0) ? '<span class="text-xs text-green-600 border border-green-200 px-1 rounded ml-1">返却P</span>' : '';
                    // For buyout, we might want to show discount info if strict, but simplistic view for now.
                    // If effective buyout < gross, it means there are discounts.

                    // Colors / Badges
                    const carrierClass = getCarrierColor(item.carrier);
                    const isLowestText = item.isLowest ? 'text-red-600 font-bold' : 'text-gray-900 font-bold';
                    const lowestBadge = item.isLowest ? `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded font-bold ml-2">最安</span>` : '';

                    // Stock (Visual Helpers)
                    let stockStatus = '<span class="text-gray-400">-</span>';
                    if (item.variants && item.variants.length > 0) {
                        const anyInStock = item.variants.some(v => v.stock_available);
                        if (anyInStock) {
                            stockStatus = '<span class="text-blue-600 font-bold text-lg">○</span>';
                        } else {
                            stockStatus = '<span class="text-red-600 font-bold text-lg">×</span>';
                        }
                    }

                    // Product Image
                    const imgUrl = getProductImage(item.model);

                    // --- Mobile Card Content ---
                    // Shows MAIN price prominently. SUB price smaller.
                    const mobileCard = `
                    <td class="md:hidden block p-4">
                        <div class="flex gap-4 mb-2">
                             <!-- Image Section -->
                             <div class="flex-shrink-0">
                                 <img src="${imgUrl}" alt="${item.model}" class="w-16 h-auto object-contain rounded">
                             </div>
                             
                             <!-- Details Section -->
                             <div class="flex-grow">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="inline-block px-3 py-1 text-xs rounded-full shadow-sm mb-1 ${carrierClass}">${getCarrierDisplayName(item.carrier)}</span>
                                    ${lowestBadge}
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 leading-tight">
                                    ${item.model} 
                                    <span class="text-sm font-normal text-gray-500 ml-1">${item.storage}</span>
                                </h3>
                            </div>
                        </div>
                        
                        <!-- Main Price -->
                        <div class="flex items-baseline gap-2 mb-1 ml-20">
                            <span class="text-sm text-gray-500">${mainLabel}:</span>
                            <span class="text-2xl ${isLowestText}">¥${mainPriceStr}</span>
                            ${(priceMode === 'rent') ? rentExemptionBadge : ''}
                        </div>
                        
                        <!-- Sub Prices & Info -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-gray-600 mb-4 ml-20">
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span>${subLabel}:</span>
                                <span>¥${subPriceStr}</span>
                            </div>
                             <div class="flex justify-between border-b border-gray-100 pb-1 items-center">
                                <span>在庫:</span>
                                ${stockStatus}
                            </div>
                        </div>
                        
                        <a href="${item.url}" target="_blank" class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-lg hover:bg-blue-700 transition active:scale-95 shadow-sm">
                            公式サイトへ
                        </a>
                    </td>
                    `;

                    // --- Desktop Table Content ---
                    // Columns: Image, Model, Storage, Carrier, SubPrice(Col4), MainPrice(Col5), Button

                    const grossDisplayClass = priceMode === 'buyout' ? isLowestText + " text-base" : 'text-gray-600 text-sm';
                    const col5Class = isLowestText + " text-base";

                    // Col4 Content (Sub Price)
                    let col4Content = '';
                    if (priceMode === 'rent') {
                        // Sub is Gross
                        col4Content = `¥${formatPrice(item.price_gross)}`;
                    } else {
                        // Sub is Rent
                        col4Content = `¥${formatPrice(item.price_effective_rent)}` + '<br><span class="text-xs text-gray-400">実質</span>';
                    }

                    // Col5 Content (Main Price)
                    let col5Content = '';
                    if (priceMode === 'rent') {
                        // Main is Rent
                        col5Content = `
                            <span class="${col5Class}">¥${formatPrice(item.price_effective_rent)}</span>
                            ${item.program_exemption > 0 ? '<br><span class="text-xs text-green-600">返却CP</span>' : ''}
                       `;
                    } else {
                        // Main is Buyout Effective
                        col5Content = `
                            <span class="${col5Class}">¥${formatPrice(item.price_effective_buyout)}</span>
                            ${(item.discount_official > 0 || item.points_awarded > 0) ? '<br><span class="text-xs text-green-600">値引/pt含</span>' : ''}
                       `;
                    }

                    // Reconstruct columns
                    const desktopColumns = `
                    <td class="hidden md:table-cell p-4">
                        <img src="${imgUrl}" alt="${item.model}" class="w-12 h-auto object-contain">
                    </td>
                    <td class="hidden md:table-cell p-4 font-medium">${item.model}</td>
                    <td class="hidden md:table-cell p-4 text-gray-600">${item.storage}</td>
                    <td class="hidden md:table-cell p-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs ${carrierClass}">
                            ${getCarrierDisplayName(item.carrier)}
                        </span>
                    </td>
                    <td class="hidden md:table-cell p-4 text-right">
                         <span class="text-gray-600 text-sm">${col4Content}</span>
                    </td>
                    <td class="hidden md:table-cell p-4 text-right">
                        <div>
                             ${col5Content}
                        </div>
                    </td>
                    <td class="hidden md:table-cell p-4 text-center">
                         <a href="${item.url}" target="_blank" class="inline-block px-4 py-2 border border-blue-600 rounded text-blue-600 hover:bg-blue-50 text-sm font-medium transition-colors">
                            公式サイトへ
                        </a>
                    </td>
                    `;

                    tr.innerHTML = mobileCard + desktopColumns;
                    productListEl.appendChild(tr);
                });
            }

            function getCarrierColor(carrier) {
                if (carrier === 'Rakuten') return 'bg-[#BF0087] text-white font-bold';
                if (carrier === 'ahamo') return 'bg-[#28C842] text-white font-bold';
                if (carrier === 'UQ mobile') return 'bg-[#E60012] text-white font-bold';
                return 'bg-gray-500 text-white font-bold';
            }

            function getCarrierDisplayName(carrier) {
                if (carrier === 'Rakuten') return '楽天モバイル';
                return carrier;
            }

            function getProductImage(model) {
                // Shorten model name for URL
                let shortName = model.replace('iPhone ', '').trim();
                return `https://placehold.co/100x120/eeeeee/333333/png?text=${encodeURIComponent(shortName)}`;
            }
        </script>
</body>

</html>